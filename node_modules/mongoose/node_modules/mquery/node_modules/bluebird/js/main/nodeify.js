"use strict";
module.exports = function(Promise) {
var util = require("./util.js");
var async = require("./async.js");
var tryCatch = util.tryCatch;
var errorObj = util.errorObj;

function spreadAdapter(val, nodeback) {
    var promise = this;
    if (!util.isArray(val)) return successAdapter.call(promise, val, nodeback);
<<<<<<< HEAD
    var ret =
        tryCatch(nodeback).apply(promise._boundValue(), [null].concat(val));
=======
    var ret = tryCatch(nodeback).apply(promise._boundTo, [null].concat(val));
>>>>>>> 58877f5fe090deefc7c81458943a78052c8521e7
    if (ret === errorObj) {
        async.throwLater(ret.e);
    }
}

function successAdapter(val, nodeback) {
    var promise = this;
<<<<<<< HEAD
    var receiver = promise._boundValue();
=======
    var receiver = promise._boundTo;
>>>>>>> 58877f5fe090deefc7c81458943a78052c8521e7
    var ret = val === undefined
        ? tryCatch(nodeback).call(receiver, null)
        : tryCatch(nodeback).call(receiver, null, val);
    if (ret === errorObj) {
        async.throwLater(ret.e);
    }
}
function errorAdapter(reason, nodeback) {
    var promise = this;
    if (!reason) {
        var target = promise._target();
        var newReason = target._getCarriedStackTrace();
        newReason.cause = reason;
        reason = newReason;
    }
<<<<<<< HEAD
    var ret = tryCatch(nodeback).call(promise._boundValue(), reason);
=======
    var ret = tryCatch(nodeback).call(promise._boundTo, reason);
>>>>>>> 58877f5fe090deefc7c81458943a78052c8521e7
    if (ret === errorObj) {
        async.throwLater(ret.e);
    }
}

<<<<<<< HEAD
Promise.prototype.asCallback =
=======
Promise.prototype.asCallback = 
>>>>>>> 58877f5fe090deefc7c81458943a78052c8521e7
Promise.prototype.nodeify = function (nodeback, options) {
    if (typeof nodeback == "function") {
        var adapter = successAdapter;
        if (options !== undefined && Object(options).spread) {
            adapter = spreadAdapter;
        }
        this._then(
            adapter,
            errorAdapter,
            undefined,
            this,
            nodeback
        );
    }
    return this;
};
};
